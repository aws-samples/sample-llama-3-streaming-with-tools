<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Bedrock LLM with Streaming and Tool Use</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div>
        <h1>Amazon Bedrock LLM with Streaming and Tool Use</h1>
        <p class="description">
            This example demonstrates streaming responses from Amazon Bedrock's Llama 3 model with tool use capabilities.
            Try asking about weather in different locations.
        </p>
        <textarea id="prompt" rows="4" placeholder="Enter your prompt here...">Choose a random state in the USA and then choose a small town in that state, then report the weather there.</textarea>
        <br>
        <div class="button-container">
            <button id="streamButton" onclick="generateStreamingResponse()">Generate Response</button>
        </div>
        <div id="response"></div>
    </div>
    <div class="footer">
        <a href="index.html">Back to Menu</a>
    </div>
    <script>
        /**
         * This example demonstrates how to combine streaming responses with tool use.
         * It uses Server-Sent Events (SSE) to receive real-time updates from the server,
         * including both text content and tool interactions.
         */
        
        // Global variable to store the current EventSource connection
        let currentEventSource = null;

        /**
         * Initiates or stops a streaming response with tool use
         * Uses Server-Sent Events (SSE) to receive chunks in real-time
         */
        async function generateStreamingResponse() {
            const promptElement = document.getElementById('prompt');
            const responseElement = document.getElementById('response');
            const streamButton = document.getElementById('streamButton');
            
            // If we're already streaming, stop the stream
            if (currentEventSource) {
                stopStream();
                return;
            }
            
            // Disable button while processing
            streamButton.disabled = true;
            
            try {
                const prompt = promptElement.value.trim();
                
                // Input validation
                if (!prompt) {
                    responseElement.innerHTML = '<p class="warning">Please enter a prompt.</p>';
                    streamButton.disabled = false;
                    return;
                }

                // Clear previous response
                responseElement.innerHTML = '<p><strong>Response:</strong> </p>';
                const responseParagraph = document.createElement('p');
                responseElement.appendChild(responseParagraph);
                
                // Change button text to "Stop Stream"
                streamButton.textContent = "Stop Stream";
                streamButton.disabled = false;
                
                // Establish SSE connection to the streaming API endpoint with tools
                currentEventSource = new EventSource(`/api/generate/stream-tools?prompt=${encodeURIComponent(prompt)}`);
                
                // Handle incoming messages from the stream
                currentEventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Handle different types of messages
                        if (data.error) {
                            // Error message
                            responseElement.innerHTML += `<p class="error">Error: ${data.error}</p>`;
                            stopStream();
                        } else if (data.done) {
                            // Stream completed
                            stopStream();
                        } else if (data.toolCall) {
                            // Tool call - display in a highlighted box
                            displayToolCall(responseElement, data);
                        } else if (data.toolResponse) {
                            // Tool response - display in a highlighted box
                            displayToolResponse(responseElement, data);
                        } else if (data.text) {
                            // Regular text content - append to the response
                            responseParagraph.textContent += data.text;
                        }
                    } catch (error) {
                        console.error('Error parsing data:', error);
                    }
                };
                
                // Handle connection errors
                currentEventSource.onerror = () => {
                    responseElement.innerHTML += '<p class="error">Connection error. Please try again.</p>';
                    stopStream();
                };
                
            } catch (error) {
                responseElement.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                stopStream();
            }
        }

        /**
         * Displays a tool call in the UI
         * 
         * @param {HTMLElement} container - The container element
         * @param {Object} data - The tool call data
         */
        function displayToolCall(container, data) {
            const toolDiv = document.createElement('div');
            toolDiv.className = 'tool-call';
            
            // Parse the tool arguments
            const toolArgs = JSON.parse(data.toolArgs);
            
            toolDiv.innerHTML = `
                <p><strong>Weather Tool Called:</strong> Checking weather for ${toolArgs.location}</p>
                <pre>${JSON.stringify(toolArgs, null, 2)}</pre>
            `;
            container.appendChild(toolDiv);
        }

        /**
         * Displays a tool response in the UI
         * 
         * @param {HTMLElement} container - The container element
         * @param {Object} data - The tool response data
         */
        function displayToolResponse(container, data) {
            const responseDiv = document.createElement('div');
            responseDiv.className = 'tool-response';
            
            // Format the weather data nicely
            responseDiv.innerHTML = `
                <p><strong>Weather Data:</strong></p>
                <ul>
                    <li><strong>Location:</strong> ${data.toolResponse.location}</li>
                    <li><strong>Temperature:</strong> ${data.toolResponse.temperature}Â°C</li>
                    <li><strong>Condition:</strong> ${data.toolResponse.condition}</li>
                    <li><strong>Humidity:</strong> ${data.toolResponse.humidity}</li>
                    <li><strong>Wind:</strong> ${data.toolResponse.wind}</li>
                </ul>
            `;
            container.appendChild(responseDiv);
        }

        /**
         * Stops the current stream and resets the UI
         */
        function stopStream() {
            const streamButton = document.getElementById('streamButton');
            
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            
            // Reset button text and enable
            streamButton.textContent = "Generate Response";
            streamButton.disabled = false;
        }
    </script>
</body>
</html>