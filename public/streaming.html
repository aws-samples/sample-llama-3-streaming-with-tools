<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Bedrock LLM with Streaming</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div>
        <h1>Amazon Bedrock LLM with Streaming</h1>
        <p class="description">
            This example demonstrates streaming responses from Amazon Bedrock's Llama 3 model.
            See the responses appear in real-time as they're generated.
        </p>
        <textarea id="prompt" rows="4" placeholder="Enter your prompt here...">List all the USA state capitals in alphabetical order.</textarea>
        <br>
        <div class="button-container">
            <button id="streamButton" onclick="generateStreamingResponse()">Generate Response</button>
        </div>
        <div id="response"></div>
    </div>
    <div class="footer">
        <a href="index.html">Back to Menu</a>
    </div>
    <script>
        /**
         * This example demonstrates how to implement streaming responses from Bedrock.
         * It uses Server-Sent Events (SSE) to receive text chunks in real-time as
         * they are generated by the model.
         */
        
        // Global variable to store the current EventSource connection
        let currentEventSource = null;

        /**
         * Initiates or stops a streaming response
         * Uses Server-Sent Events (SSE) to receive chunks in real-time
         */
        async function generateStreamingResponse() {
            const promptElement = document.getElementById('prompt');
            const responseElement = document.getElementById('response');
            const streamButton = document.getElementById('streamButton');
            
            // If we're already streaming, stop the stream
            if (currentEventSource) {
                stopStream();
                return;
            }
            
            // Disable button while processing
            streamButton.disabled = true;
            
            try {
                const prompt = promptElement.value.trim();
                
                // Input validation
                if (!prompt) {
                    responseElement.innerHTML = '<p class="warning">Please enter a prompt.</p>';
                    streamButton.disabled = false;
                    return;
                }

                // Prepare the response area
                responseElement.innerHTML = '<p><strong>Response:</strong> </p>';
                const responseParagraph = document.createElement('p');
                responseElement.appendChild(responseParagraph);
                
                // Change button text to "Stop Stream"
                streamButton.textContent = "Stop Stream";
                streamButton.disabled = false;
                
                // Establish SSE connection to the streaming API endpoint
                currentEventSource = new EventSource(`/api/generate/stream?prompt=${encodeURIComponent(prompt)}`);
                
                // Handle incoming messages from the stream
                currentEventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Handle different types of messages
                        if (data.error) {
                            // Error message
                            responseElement.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                            stopStream();
                        } else if (data.done) {
                            // Stream completed
                            stopStream();
                        } else if (data.text) {
                            // Regular text content - append to the response
                            responseParagraph.textContent += data.text;
                        }
                    } catch (error) {
                        console.error('Error parsing data:', error);
                    }
                };
                
                // Handle connection errors
                currentEventSource.onerror = () => {
                    responseElement.innerHTML += '<p class="error">Connection error. Please try again.</p>';
                    stopStream();
                };
                
            } catch (error) {
                responseElement.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                stopStream();
            }
        }

        /**
         * Stops the current stream and resets the UI
         */
        function stopStream() {
            const streamButton = document.getElementById('streamButton');
            
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            
            // Reset button text and enable
            streamButton.textContent = "Generate Response";
            streamButton.disabled = false;
        }
    </script>
</body>
</html>